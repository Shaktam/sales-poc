<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SalesCounter Analytics</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --border: #1f2937;
      --border-light: #334155;
      --card-bg: #0b1220;
    }
    
    [data-theme="light"] {
      --bg: #f8fafc;
      --panel: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --accent: #16a34a;
      --danger: #dc2626;
      --warning: #d97706;
      --border: #e2e8f0;
      --border-light: #cbd5e1;
      --card-bg: #f1f5f9;
    }
    
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    a { color: var(--accent); text-decoration: none; }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 12px; }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    header h1 { margin: 0; font-size: 20px; }
    header nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    header nav a {
      padding: 6px 12px;
      border-radius: 6px;
      opacity: .9;
      transition: opacity 0.2s, background 0.2s;
    }
    header nav a:hover { opacity: 1; background: var(--card-bg); }
    
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--card-bg);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
    }
    .theme-toggle:hover { filter: brightness(0.95); }
    .theme-switch {
      width: 44px;
      height: 24px;
      background: var(--border-light);
      border-radius: 12px;
      position: relative;
      transition: background 0.3s;
    }
    .theme-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    [data-theme="light"] .theme-switch { background: var(--accent); }
    [data-theme="light"] .theme-switch::after { transform: translateX(20px); }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      transition: background 0.3s, border-color 0.3s;
    }
    .section-title {
      margin: 0 0 8px;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px dashed var(--border-light);
      font-size: 14px;
    }
    th {
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
    }
    
    .kpi {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .kpi .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      transition: background 0.3s, border-color 0.3s;
    }
    .kpi .label {
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .kpi .value {
      font-size: 22px;
      margin-top: 6px;
      font-weight: 600;
    }
    
    .btn {
      border: 1px solid var(--border-light);
      background: var(--card-bg);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      min-height: 32px;
      touch-action: manipulation;
    }
    .btn:hover { filter: brightness(0.95); }
    .btn:active { transform: scale(0.98); }
    .btn-danger {
      border-color: var(--danger);
      background: var(--danger);
      color: white;
    }
    .btn-warning {
      border-color: var(--warning);
      background: var(--warning);
      color: white;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      min-height: 28px;
    }
    
    .actions-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }
    .message-success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--accent);
      color: var(--accent);
    }
    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      transition: background 0.3s, border-color 0.3s;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 18px;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .modal-close:hover {
      background: var(--card-bg);
      color: var(--danger);
    }
    .bill-items-list {
      margin: 12px 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .bill-item-row {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      border-bottom: 1px dashed var(--border-light);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container { padding: 8px; }
      header { flex-direction: column; align-items: flex-start; }
      header nav { width: 100%; justify-content: space-between; }
      .grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .kpi {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .kpi .value { font-size: 20px; }
      table {
        font-size: 13px;
      }
      th, td {
        padding: 6px;
        font-size: 12px;
      }
      .actions-panel {
        flex-direction: column;
        align-items: stretch;
      }
      .actions-panel button {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      header h1 { font-size: 18px; }
      .kpi .value { font-size: 18px; }
      th, td {
        padding: 4px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Analytics</h1>
      <nav>
        <a href="/">POS</a>
        <a href="/analytics">Analytics</a>
        <a href="/admin">Admin</a>
        <div class="theme-toggle" onclick="toggleTheme()">
          <span>üåô</span>
          <div class="theme-switch"></div>
          <span>‚òÄÔ∏è</span>
        </div>
      </nav>
    </header>

    <div id="message" class="message"></div>

    <div class="actions-panel">
      <div>
        <strong>Sales Management</strong>
      </div>
      <button class="btn btn-danger" onclick="clearSales()">Clear All Sales Data</button>
    </div>

    <section class="kpi">
      <div class="card">
        <div class="label">Total Revenue</div>
        <div id="totalRevenue" class="value">‚Ç¨0.00</div>
      </div>
      <div class="card">
        <div class="label">Top Item</div>
        <div id="topItem" class="value">‚Äî</div>
      </div>
      <div class="card">
        <div class="label">Top Category</div>
        <div id="topCategory" class="value">‚Äî</div>
      </div>
    </section>

    <div class="grid">
      <section class="panel">
        <h3 class="section-title">Item Analytics</h3>
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty Sold</th>
                <th>Revenue</th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>
        </div>
      </section>

      <section class="panel">
        <h3 class="section-title">Category Analytics</h3>
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>Category</th>
                <th>Qty Sold</th>
                <th>Revenue</th>
              </tr>
            </thead>
            <tbody id="categoriesBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <section class="panel" style="margin-top: 16px;">
      <h3 class="section-title">Bills</h3>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Bill Number</th>
              <th>Date</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="billsBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Bill Details Modal -->
  <div id="billModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Bill Details</h2>
        <button class="modal-close" onclick="closeBillModal()">&times;</button>
      </div>
      <div id="billModalContent"></div>
    </div>
  </div>

  <script>
    // Theme Management
    function initTheme() {
      const theme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
    }
    
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }
    
    initTheme();

    function showMessage(text, type = 'success') {
      const messageDiv = document.getElementById('message');
      messageDiv.className = `message message-${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 3000);
    }

    const formatMoney = (n) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(n ?? 0);
    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      return date.toLocaleDateString('de-DE', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    };

    async function loadRevenue() {
      const res = await fetch('/api/analytics/revenue');
      const { total_revenue } = await res.json();
      document.getElementById('totalRevenue').textContent = formatMoney(total_revenue);
    }

    async function loadItemAnalytics() {
      const res = await fetch('/api/analytics/items');
      const rows = await res.json();
      const body = document.getElementById('itemsBody');
      body.innerHTML = '';
      if (rows.length === 0) {
        body.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--muted);padding:20px;">No sales data</td></tr>';
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.name}</td><td>${r.total_quantity_sold}</td><td>${formatMoney(r.total_revenue)}</td>`;
        body.appendChild(tr);
      });
      if (rows[0]) document.getElementById('topItem').textContent = `${rows[0].name} (${formatMoney(rows[0].total_revenue)})`;
    }

    async function loadCategoryAnalytics() {
      const res = await fetch('/api/analytics/categories');
      const rows = await res.json();
      const body = document.getElementById('categoriesBody');
      body.innerHTML = '';
      if (rows.length === 0) {
        body.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--muted);padding:20px;">No sales data</td></tr>';
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.name}</td><td>${r.total_items_sold}</td><td>${formatMoney(r.total_revenue)}</td>`;
        body.appendChild(tr);
      });
      if (rows[0]) document.getElementById('topCategory').textContent = `${rows[0].name} (${formatMoney(rows[0].total_revenue)})`;
    }

    async function loadBills() {
      const res = await fetch('/api/bills');
      const bills = await res.json();
      const body = document.getElementById('billsBody');
      body.innerHTML = '';
      if (bills.length === 0) {
        body.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px;">No bills found</td></tr>';
        return;
      }
      bills.forEach(bill => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${bill.bill_number}</td>
          <td>${formatDate(bill.created_at)}</td>
          <td>${formatMoney(bill.total_amount)}</td>
          <td>
            <button class="btn btn-warning btn-small" onclick="viewBill(${bill.id})">View</button>
            <button class="btn btn-danger btn-small" onclick="deleteBill(${bill.id})">Delete</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    async function viewBill(billId) {
      try {
        const res = await fetch(`/api/bills/${billId}`);
        if (!res.ok) {
          showMessage('Failed to load bill details', 'error');
          return;
        }
        const bill = await res.json();
        
        const content = document.getElementById('billModalContent');
        let itemsHtml = '';
        if (bill.items && bill.items.length > 0) {
          itemsHtml = bill.items.map(item => `
            <div class="bill-item-row">
              <div>
                <strong>${item.item_name}</strong><br>
                <small>Qty: ${item.quantity} √ó ${formatMoney(item.unit_price)}</small>
              </div>
              <div>${formatMoney(item.subtotal)}</div>
            </div>
          `).join('');
        }
        
        content.innerHTML = `
          <div>
            <p><strong>Bill Number:</strong> ${bill.bill_number}</p>
            <p><strong>Date:</strong> ${formatDate(bill.created_at)}</p>
            <p><strong>Total:</strong> ${formatMoney(bill.total_amount)}</p>
          </div>
          <div class="bill-items-list">
            <h4 style="margin:12px 0 8px;">Items:</h4>
            ${itemsHtml || '<p style="color:var(--muted);">No items</p>'}
          </div>
          <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border-light);">
            <button class="btn btn-danger" onclick="deleteBill(${bill.id}, true)">Delete Bill</button>
            <button class="btn" onclick="closeBillModal()" style="margin-left:8px;">Close</button>
          </div>
        `;
        
        document.getElementById('billModal').classList.add('active');
      } catch (error) {
        showMessage('Error loading bill: ' + error.message, 'error');
      }
    }

    function closeBillModal() {
      document.getElementById('billModal').classList.remove('active');
    }

    async function deleteBill(billId, fromModal = false) {
      if (!fromModal && !confirm('Are you sure you want to delete this bill?')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/bills/${billId}`, {
          method: 'DELETE'
        });

        if (!res.ok) {
          const err = await res.json();
          showMessage(err.error || 'Failed to delete bill', 'error');
          return;
        }

        showMessage('Bill deleted successfully!');
        if (fromModal) closeBillModal();
        await Promise.all([loadBills(), loadRevenue(), loadItemAnalytics(), loadCategoryAnalytics()]);
      } catch (error) {
        showMessage('Error deleting bill: ' + error.message, 'error');
      }
    }

    async function clearSales() {
      if (!confirm('Are you sure you want to clear ALL sales and analytics data? This action cannot be undone.')) {
        return;
      }
      
      try {
        const res = await fetch('/api/bills/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          const err = await res.json();
          showMessage(err.error || 'Failed to clear sales data', 'error');
          return;
        }

        showMessage('All sales data cleared successfully!');
        await Promise.all([loadRevenue(), loadItemAnalytics(), loadCategoryAnalytics(), loadBills()]);
      } catch (error) {
        showMessage('Error clearing sales data: ' + error.message, 'error');
      }
    }

    // Close modal on background click
    document.getElementById('billModal').addEventListener('click', (e) => {
      if (e.target.id === 'billModal') {
        closeBillModal();
      }
    });

    (async function init() {
      await Promise.all([loadRevenue(), loadItemAnalytics(), loadCategoryAnalytics(), loadBills()]);
    })();
  </script>
</body>
</html>
